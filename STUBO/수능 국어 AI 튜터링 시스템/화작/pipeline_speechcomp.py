# -*- coding: utf-8 -*-
"""pipeline_speechcomp.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1sGEBK0mgK3UxnDkuqjc9YtHCGTNq-oOj
"""

import os

if __name__ == "__main__":  # ì´ íŒŒì¼ì´ ì§ì ‘ ì‹¤í–‰ë  ë•Œë§Œ
    try:
        from google.colab import drive
        drive.mount('/content/drive')
    except:
        pass

# ìœ ì‚¬ ë¬¸ì œ ì¶”ì²œê³¼ ë‹µë³€ í•´ì„¤ì„ ë™ì‹œì— í•˜ëŠ” ìµœì¢… ëª¨ë¸
import openai
import os
import base64
import easyocr
import pytesseract
import re
from PIL import Image
from langchain_community.vectorstores import FAISS
from langchain_community.embeddings import SentenceTransformerEmbeddings

# GPT client ì„¤ì •
client = openai.OpenAI(api_key="  ")  # API í‚¤ ì…ë ¥ í•„ìš”

# ê²½ë¡œ ì„¤ì •
BASE_DIR = "/content/drive/MyDrive/Colab Notebooks/TAVE í”„ë¡œì íŠ¸_STUBO/ìˆ˜ëŠ¥ êµ­ì–´ AI íŠœí„°ë§ ì‹œìŠ¤í…œ/í™”ì‘"
DATA_DIR = os.path.join(BASE_DIR, "data")
VECTOR_DB_PATH = os.path.join(BASE_DIR, "outputs")  # FAISS vector DBê°€ ì €ì¥ëœ í´ë”

# [5] EasyOCR Reader
reader = easyocr.Reader(['ko', 'en'])

# [6] ì„ë² ë”© ëª¨ë¸ & ë²¡í„° ìŠ¤í† ì–´ ë¡œë”©
embedding_model = SentenceTransformerEmbeddings(model_name="snunlp/KR-SBERT-V40K-klueNLI-augSTS")
vectorstore = FAISS.load_local(VECTOR_DB_PATH, embedding_model, allow_dangerous_deserialization=True)
retriever = vectorstore.as_retriever(search_kwargs={"k": 3})

# [7] ì´ë¯¸ì§€ ì¸ì½”ë”©
def encode_image(image_path):
    with open(image_path, "rb") as image_file:
        return base64.b64encode(image_file.read()).decode("utf-8")

# [8] OCR í•¨ìˆ˜
def easyocr_text(image_path):
    result = reader.readtext(image_path, detail=0, paragraph=True)
    return "\n".join(result)

def pytesseract_text(image_path):
    img = Image.open(image_path)
    return pytesseract.image_to_string(img, lang="kor+eng")

def extract_problem_number(text: str) -> str:
    match = re.match(r"\s*(\d+)[\.\)]?\s*ë¬¸ì œ", text)
    return match.group(1) if match else "ë²ˆí˜¸ ì—†ìŒ"

def analyze_problem(context_image_path, question_image_path, top_k=2):
    result_dict = {}

    # ğŸ”§ ë‚´ë¶€ ì„¤ì •
    base_img_dir = "/content/drive/MyDrive/Colab Notebooks/TAVE í”„ë¡œì íŠ¸_STUBO/ìˆ˜ëŠ¥ êµ­ì–´ AI íŠœí„°ë§ ì‹œìŠ¤í…œ/í™”ì‘/data/output_images"
    page_map = {
        "p9": [35, 36, 37],
        "p10": [38, 39, 40, 41, 42],
        "p11": [43, 44, 45],
    }

    # [1] GPT ì •ë‹µ/í•´ì„¤ ìƒì„±
    context_text = easyocr_text(context_image_path)
    question_text = easyocr_text(question_image_path)

    c_b64 = encode_image(context_image_path)
    q_b64 = encode_image(question_image_path)

    response = openai.chat.completions.create(
        model="gpt-4o",
        messages=[
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": (
                        f"ë‹¤ìŒì€ OCRë¡œ ì¶”ì¶œí•œ ì§€ë¬¸ í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤:\n{context_text}\n\n"
                        f"ë‹¤ìŒì€ OCRë¡œ ì¶”ì¶œí•œ ë¬¸ì œì™€ ì„ íƒì§€ í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤:\n{question_text}\n\n"
                        "ìœ„ ë‘ ì´ë¯¸ì§€ì™€ OCR í…ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•˜ì—¬ ë¬¸ì œì˜ ì •ë‹µê³¼ í•´ì„¤ì„ ì•Œë ¤ì¤˜. "
                        "ì •ë‹µ ë²ˆí˜¸ì™€ í•´ì„¤ì„ ë¶„ë¦¬í•´ì„œ ì•Œë ¤ì¤˜. (ì˜ˆ: ì •ë‹µ: â‘¢) "
                        "ëª¨ë“  ì„ ì§€ì— ëŒ€í•œ í•´ì„¤ì„ ì œê³µí•´ì¤˜."
                    )},
                    {"type": "image_url", "image_url": {"url": f"data:image/png;base64,{c_b64}"}},
                    {"type": "image_url", "image_url": {"url": f"data:image/png;base64,{q_b64}"}},
                ]
            }
        ],
        max_tokens=5000,
    )

    gpt_response = response.choices[0].message.content
    full_text = pytesseract_text(question_image_path)

    # [2] ìœ ì‚¬ ë¬¸ì œ ì¶”ì²œ
    similar_docs = retriever.get_relevant_documents(full_text, k=top_k)
    similar_problems = []

    for i, doc in enumerate(similar_docs, 1):
        meta = doc.metadata
        year = str(meta.get("ë…„ë„", "ì—°ë„ ì—†ìŒ"))
        month = str(meta.get("ì›”", "ì›” ì—†ìŒ")).zfill(2)
        question_text = doc.page_content

        # ë¬¸ì œ ë²ˆí˜¸ ì¶”ì¶œ
        match = re.match(r"\s*(\d+)[\.\)]?", question_text)
        problem_number = match.group(1) if match else "ë²ˆí˜¸ì—†ìŒ"

        # ì´ë¯¸ì§€ íŒŒì¼ëª… ì¶”ë¡ 
        problem_filename = f"{year}-{month}-í™”ì‘_{problem_number}.png"
        passage_filename = meta.get("passage_img", "")

        # ì§€ë¬¸ ì¶”ë¡ 
        if not passage_filename and problem_number.isdigit():
            for page, numbers in page_map.items():
                if int(problem_number) in numbers:
                    passage_filename = f"{year}-{month}-í™”ì‘_{page}.png"
                    break

        # ì „ì²´ ê²½ë¡œ ìƒì„±
        passage_img_path = os.path.join(base_img_dir, passage_filename) if passage_filename else ""
        problem_img_path = os.path.join(base_img_dir, problem_filename)

        similar_problems.append({
            "index": i,
            "year": year,
            "month": month,
            "answer": meta.get("ë‹µ", None),
            "explanation": meta.get("í•´ì„¤", None),
            "content": question_text,
            "problem_number": problem_number,
            "passage_img_path": passage_img_path,
            "problem_img_path": problem_img_path,
        })

    return {
        "problem_number": extract_problem_number(full_text),
        "gpt_response": gpt_response,
        "similar_problems": similar_problems,
    }